

# AndroidAPS Autotune adaptation

## Autotune Plugin files

### AutotunePlugin

<=> oref0-autotune.sh

<=> default value for Autotune log is **disable** (autotune always generate a dedicated log file in autotune subfolder)

### AutotuneFragment

User Interface

### AutotunePrep

<=> oref0-autotune-prep.js + lib/autotune-prep

### AutotuneCore

<=> oref0-autotune-core.js = lib/autotune

### AutotuneIob

<=> lib/iob + lib/meal 

get ns-entries and ns-treatments input data for each days

exports these data as json file to run oref0-autotune algorythm with aaps data in a Virtual Machine

Make dedicated Iob calculation for autotune (specificities compared to iob calculation for loop...)

### AutotuneFS

Manage exported files for tests and  verifications of autotune plugin

=> Add settings and autotune subfolder in androidAps log folder

=> Add a zip file beside log files for each autotune run with all generated data

### data folder

`PreppedGlucose`: output data of AutotunePrep and input data of AutotuneCore (it contains `BGDatum`, `CRDatum` data)

- `DiaDatum` and `PeakDatum` created for later update but not used currently

### other files created or modified

- `ATProfile` (in core) used to manipulate easily profiles by Autotune plugin (it includes pumpProfile (input) and is updated from start day to end day, and include method for profileSwitches, Update Block for Local profile, json generation in oref0 format...)
- `LocalInsulin` class (core module data folder) I used a dedicated class to calculate iob and activity to be able to use independant values of Peak and Dia (not the same than InsulinPlugin)
- `IobTotal` (add logCalc property to allow detailed calculation exported in log files to compare all iob/activities)
- `ProfileSealed` / `Profile` interface: to allow access to profileName from ATProfile
- `InsulinOrefBasePlugin` / `Insulin` interface (to access to peak value from autotune plugin)
- `BolusExtension` / `ExtendedBolusExtension` / `TemporaryBasalExtension` (to convert TBR and Ex Boluses to little boluses of +/- 0.05U and to calculate iob/activity with `localInsulin`
- `DateUtil` (to add toISOString with dedicated format for exported files)
- `UserEntry` / `Translator` / `UserEntryMapper` and `UserEntryPresentationHelper` (for uel integration of autotune)
- `MaintenancePlugin` (to delete the oldest `Autotune_yyyy-mm-dd_hh-mm-ss.zip` files)
- Automation module
  - `ActionRunAutotune` added
  - `InputDuration` modified (to add `DAYS` in enum)
  - `InputProfileName` (to add Active Profile Option for Autotune profile selection)

### oref0 folder

**aaps-autotune**.sh: patched oref0-autotune.sh file to run oref0-autotune with aaps exported file (pumpprofile, ns-entries.yyyy-mm-dd.json and ns-treatments.yyyy-mm-dd.json). zip previous files and query are disabled (to check consistency between **autotune.yyyy-mm-dd.json** and **aaps-autotune.yyyy-mm-dd.json**)

**aaps1-autotune.sh**: patched oref0-autotune.sh file to run oref0-autotune-core with aaps-autotune.yyyy-mm-dd.json files

## Files generated by AAPS autotune plugin (for results verifications)

### How to compare results:

- To compare results, you have to install oref0 on a virtual linux machine, 

- add **aaps-autotune** and **aaps-autotune-recommends-report** files in `/usr/local/bin` folder

- create an `aaps` folder in user directory

- copy / paste the 2 folders generated by aaps autotune plugin in log folder (`autotune` and `settings`) with all files included

- then launch `oref0-autotune` command line or `aaps-autotune` command line from home

  **Note**, in the `settings.json` file exported in `settings` folder, you have the syntax of oref0_command (with NS queries), aaps_command (`aaps-autotune ....`) and the timezone command to apply same time zone than in AAPS application.

### Input files (for oref0 check)

- settings.json: contains all necessary information to be able to run oref0-autotune on a virtual machine (NS website, date of run, nb of days, timezone...)
- pumpprofile.json: current profile, (input data), converted in oref json format to be able to run oref0-autotune.sh (in settings folder and autotune folder)
- aaps-entries.yyyy-mm-dd.json (<=> ns-entries.yyyy-mm-dd.json): BG data get with line below and converted in NS json format 
- aaps-treatments.yyyy-mm-dd.json (<=> ns-entries.yyyy-mm-dd.json): all treatments for autotune calculation (meals, insulin, temp basals, extended basals). 

note oref0 autotune doesn't manage profile-switch so it could have some gap on iob calculation when no TBR running (calculation done with 4 hours average pumpprofile)

- It's important to be able to export in NS Json format all data used in aaps autotune plugin to be able to run oref0-autotune with the datas generated by aaps and compare results

#### To compare results between aaps plugin and oref0, I just have to:

1) copy the 2 folders included in ``autotune_2022-xx-xx_xx_xx.zip`` file in AndroidAPS log folder in the subfolder named ``aaps`` created in home directory of virtual machine

2) update timezone of virtual machine (dedicated command is included in ``settings.json`` file)

3)  run the `aaps-autotune` command (oref0-autotune.sh file with NS queries disabled), (exact command with option and associated day start and end is included in ``settings.json`` file)

That way I can compared results and all detailled informations (aaps logs and oref0 logs are very close) and they must be as close as possible...

### Ouput files

- `autotune.json`: output profile in aaps json format (in settings folder)
- `aaps-autotune.yyyy-mm-dd.json` (<=> `autotune.yyyy-mm-dd.json`): prepped data for autotuneCore calculation (same format than oref0 one so I can use them in virtual machine to compare oref0-autotune-core results)
- `newaapsprofile.yyyy-mm-dd.json` (<=> `newprofile.yyyy-mm-dd.json`): intermediate profiles foreach day
- `autotune.yyyy-mm-dd.log` (<=> `autotune.yyyy-mm-dd-hhmmss.log`): log file with detailed calculation (categorised data and intermediate tuned profile)
  - aaps plugin log file and oref0 lof file gives the same informations, **<u>it's the main files used to compare results</u>**
- `aaps-boluses.yyyy-mm-dd.json` only for iob calculation analysis (oref0 splits TBR little boluses of +0.05 U or - 0.05 U for IOB calculation (duration between 2 boluses depends on total absolute amount of isulin injected during the TBR, AAPS splits TBR on little boluses every "about 5min interval"). This can have impact on IOB calculation... I kept oref0 method to be as close as possible and this exported file is to be able to check if AAPS split is the same than oref0...

## Files generated by OAPS: (for results verifications)

### inputs data

- ``profil.json`` and ``pumpprofile.json``:
  - insulin informations (if not default "rapid-acting" insulin) is specified in ``pumpprofile.json`` file with an additional entry ``"curve":"ultra-rapid"``.
  - Free peak insulin are entered in pumpprofile.json file with this additional entries:  ``"insulinpeaktime":55 ``.
- ``ns-entries.yyyy-mm--dd.json``: BG data received from NSClient for each day (between 4 AM local hour and 4 AM following day). All BG are in reverse order (from end to start)

- ``ns-treatments.yyy-mm-dd.json``: Treatments data received from NSClient (6 hours before first BG data to last BG data). As query is done in UTC time on field "created_at", 12 hours extra data before and after are also downloaded...

### Output data

- ``autotune.yyy-mm-dd.json``: output file of  ``oref0-autotune-prep.js`` (and input of  ``oref0-autotune-core.js``). BG are grouped according to type (CSFGlucoseData, ISFGlucoseData or basalGlucoseData) with additional informations (mealCarbs, BGI, deviation)

## Differences between Oref0 Autotune and AAPS Autotune Plugin

### Why not exactly the same results between Oref0-Autotune and Autotune Plugin (with exactly the same input data)

- Oref0 IOB calculation for the TBRs splits each TBR every half an hour, then the absolute amount of Insulin for each "block" is divided in a number of little Bolus of 0.05U or -0.05U
  - I updated autotuneIOB file to use the same splits (to have as close as possible results), but it's better to split every hours
- Library used in kotlin and in linux system for Exponentiel curves are not the same
  - With exactly the same values of units, date of bolus, time of iob calculation, insulin iob and activity calculated on kotlin and linux with exponential curves are not "exactly" the same (even if results are very close, when you add a lot of these iob / activities, you can have little gaps in results, and more important in BGI, carbs absorption)
  - There are threshold in autotuneCore to categorized data, so you can have some little variation. (but it should not have a significant impact on tuned profile)

### Why not exactly the same results between Autotune-Web and Autotune Plugin

- Autotune Web doesn't take into account periods with no TBR running (these period doesn't have entries or "neutral TBR"), the impact of all these periods are not included in iob calculation and activities done by autotune web.
  - These "empty" periods are filled with neutral TBR (TBR with absolute value consistant with basal rate) to be included in calculation done by AAPS plugin and exported files for oref0 verification on the virtual machine
- For pumps that works with percent TBR
  - Absolute amount of TBR exported from AAPS are calculated with the "timestamp" of the TBR (no split for each hour change), but basal rates can be different on hour changes:
    - If a TBR starts at 10:59 and finish at 11:59, the absolute amount will be calculated with basal rate of Timestamp (10h), even if 59 min of TBR was injected with basal rate of the hour after (11h)
  - In AAPS plugin, each TBR and extended TBR is splitted every hour to include changes of the profile basal rates, and this splits are included in exported files for oref0 verifications
- You cannot select custom peak or Lyumjev insulin in Autotune-Web (only Rapid-Acting and Fiasp can be selected)
  - if you use lyumjev, using FIASP settings for autotune have major impact on results because of Peak duration

## Funtionalities and limitations of current version of AAPS Autotune plugin (compare to oref0)

- Categorize UAM as basal setting available (in preferences)
  - included in preferences, but results will be different only for full UAM users: if you have at least one hour of Carbs absorption detected, UAM will automatically be categorized as basal (idem oref0 autotune) even if setting is disabled (cf Scott answer in [#1383](https://github.com/openaps/oref0/issues/1383))
- Number of days can be selected (default value in preferences, you can customized in UI) from 1 to 30 days
- Launch Autotune with an automation rule is possible (you can select input profile and the number of days in automation settings)
- Automatically "Switch profile" can be enabled in preferences (default = false)
  - if Switched enabled, input profile will autoamtically be updated after autotune run
- From main UI you can :
  - Select input profile for autotune calculation
  - Adjust number of days for calculation, Run Autotune, see partial results
  - Compare profiles,
  - Copy tuned profile in Local Profile plugin (to allow modification before activation), 
  - Update input profile with autotune results
  - Activate Tuned profile manualy after calculation
- If your input profile contains circadian values of IC and/or ISF, autotune calculation is done on average values (idem oref0 autotune)
  - There is a setting to apply average percentage calculated on IC/ISF by autotune on circadian values of IC/ISF (default = false)
  - This settings is used for  Compare, Copy to Local Profile, Update Profile and Activate profile
  - I proposed this feature in oref0 repo (issue [#326](https://github.com/openaps/oref0/issues/326#issuecomment-1080010467)) but no answer until now
- Tune of Insulin (peak and dia) is not available
- Tune of specific days of the week is not available

## Further improvements

- Include Insulin tuning (for Peak and DIA) will be easier if we manage Insulin in Profile (not only DIA)
  - ``LocalInsulin`` class has been created in core module to be able to calculate IOB with other values (Peak/Dia) than in InsulinPlugin
- Improve Results presentation (html format)
- Allow week days selection (to be able to tune working days, WE days, training days with dedicated profiles) in user interface and in automation rule